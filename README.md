# photos
Personal photo management

> [!WARNING]
> Photos in the "Cloud" tab of the mobile application are retrieved using signed
> URLs from Google Cloud Storage. On **Linux** and **Windows**, HTTP/3 is not
> enforced, so these URLs are transmitted unencrypted. HTTP/3 is enforced on
> Android, iOS, and macOS.

> Most of the code is generated by using Claude Opus.

## Prerequisites

- Go 1.21+
- Flutter SDK
- [Task](https://taskfile.dev/) (optional, for task runner commands)
- Google Cloud SDK (for GCS authentication)
- Xcode (for macOS/iOS builds)
- Android SDK (for Android builds)

## Setting up gRPC Server

### 1. Install the CLI

```bash
go install
```

Or build without installing:

```bash
task build
# or: go build -o /dev/null ./...
```

### 2. Configure the server

Create a configuration file at `~/.photos.yaml` (see Configuration section below)
or use command-line flags/environment variables.

Required configuration:
- `database`: Path to SQLite database file
- `gcs_bucket`: Google Cloud Storage bucket name

Optional configuration:
- `port`: gRPC server port (default: 8080)
- `proxy_port`: REST proxy port (default: 8081)
- `hostname`, `ts_auth_key`: Enable Tailscale private networking
- `gcs_credentials`: Path to GCS service account JSON (uses ADC if not set)

### 3. Set up GCS authentication

Either set the `gcs_credentials` option to a service account JSON file, or use
Application Default Credentials:

```bash
gcloud auth application-default login
```

### 4. Start the server

```bash
photos serve
# or with flags:
photos serve --database /path/to/photos.db --gcs-bucket my-bucket
```

## Building Mobile Apps

### Android (APK)

```bash
task apk
# or: cd mobile && flutter build apk
```

The APK will be at `mobile/build/app/outputs/flutter-apk/app-release.apk`.

To copy to Desktop (macOS):

```bash
task copy-apk-to-desktop
```

### iOS

```bash
cd mobile && flutter build ios
```

For release builds, open `mobile/ios/Runner.xcworkspace` in Xcode to configure
signing and archive for distribution.

#### Deploying to iPad

1. **Open the project in Xcode**

   ```bash
   open mobile/ios/Runner.xcworkspace
   ```

2. **Configure signing**

   - Select the **Runner** project in the navigator
   - Go to **Signing & Capabilities** tab
   - Select your **Team** (Apple Developer account)
   - Xcode will automatically manage provisioning profiles

3. **Connect and select iPad**

   - Connect iPad via USB (required for first deployment)
   - Select your iPad from the device dropdown in Xcode's toolbar

4. **Build and run**

   - Press **Cmd+R** or click the Play button
   - On first deployment, trust the developer certificate on iPad:
     **Settings > General > VPN & Device Management** > Trust your certificate

   Alternatively, use Flutter CLI:

   ```bash
   flutter devices                      # find your iPad device ID
   cd mobile && flutter run -d <device-id>
   ```

### macOS

```bash
task mac
# or: cd mobile && flutter build macos
```

To run the built app:

```bash
task run-flutter-release
# or: open ./mobile/build/macos/Build/Products/Release/photos.app
```

## Configuration

Configuration can be specified via command-line flags, environment variables
(prefixed with `PHOTOS_`), or a YAML configuration file.

The default configuration file path is `~/.photos.yaml`.

### Example `~/.photos.yaml`

```yaml
# Global options
service: photos.example.ts.net:8080
insecure: false

# Server options (used by "photos serve")
port: 8080
proxy_port: 8081
database: /path/to/photos.db
hostname: photos
ts_auth_key: tskey-auth-xxxxx
ts_state_dir: ./tailscale-state
gcs_bucket: my-photos-bucket
gcs_project: my-gcp-project
gcs_credentials: /path/to/credentials.json
gcs_prefix: photos/
```
